<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tarot Chat ‚ú®</title>
<style>
  body {
    background: radial-gradient(circle at center, #1b1b1b, #0e0e0e);
    color: #e0e0e0;
    font-family: system-ui, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100vh;
    margin: 0;
    padding: 2rem 1rem;
  }

  h1 {
    margin-bottom: 1rem;
    font-weight: 500;
    color: #d5b97f;
    text-shadow: 0 0 8px rgba(213,185,127,0.5);
  }

  #chat {
    width: 480px;
    max-width: 100%;
    height: 65vh;
    overflow-y: auto;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 1em;
    background: rgba(30,30,30,0.8);
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
  }

  /* === Fix agent HTML inside the chat container === */
#chat .wrap,
#chat body {
  background: transparent !important;
  color: #e0e0e0 !important;
}

/* Fix the ‚ÄúBottom line‚Äù white box */
#chat .summary {
  background: rgba(255, 255, 255, 0.05) !important; /* subtle dark tint */
  border: 1px solid #444 !important;
  color: #f0f0f0 !important;
}

/* Fix grayed-out note text */
#chat .note {
  color: #b0b0b0 !important;   /* readable on dark background */
  opacity: 1 !important;
}

/* Ensure headings inside agent HTML match your theme */
#chat h1, #chat h2, #chat h3, #chat strong {
  color: #d5b97f !important;   /* your golden accent */
}

/* Optional: remove redundant white body background if nested <html> appears */
#chat html, 
#chat body {
  background: transparent !important;
}

  
  /* make the agent HTML fit your dark theme */
#chat .summary {
  background: #222 !important;
  border-color: #444 !important;
  color: #e0e0e0 !important;
}

/* make .note readable */
#chat .note {
  color: #aaa !important;
  opacity: 1 !important;
}

  .msg {
    margin: .75em 0;
    line-height: 1.4;
    color: #f0f0f0;
    padding: 0.5em 0.75em;
    border-radius: 6px;
    background: rgba(255,255,255,0.05);
  }

  .user {
  text-align: left;
  color: #ffffff;               /* brighter text */
  background: rgba(140,170,255,0.2); /* lighter contrast */
}

  .msg:not(.user) {
  text-align: left;
  color: #f8f8f8;
  background: rgba(255,255,255,0.08);
}

#msg {
  text-align: left;
}

  #inputBox {
    display: flex;
    gap: 8px;
    margin-top: 1rem;
    width: 480px;
    max-width: 100%;
  }

  input {
    flex: 1;
    padding: .6em;
    border-radius: 6px;
    border: 1px solid #444;
    background: #111;
    color: #fff;
  }

    textarea {
    flex: 1;
    padding: .6em;
    border-radius: 6px;
    border: 1px solid #444;
    background: #111;
    color: #fff;
    resize: none;
    font-family: inherit;
  }

  button {
    background: #d5b97f;
    color: #111;
    border: none;
    border-radius: 6px;
    padding: .6em 1.2em;
    cursor: pointer;
    font-weight: 600;
    transition: all .2s;
  }

  button:hover {
    background: #c2a862;
  }

  img {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 8px;
  }

  a {
    color: #d5b97f;
  }

/* Normalize any injected or agent HTML */
.agent-content,
.agent-content * {
  /* inherit structure, but make sure text is readable */
  color: #e0e0e0 !important;
  background: transparent !important;
  font-family: inherit !important;
  border-color: rgba(255,255,255,0.15) !important;
}

/* Headings / emphasis */
.agent-content h1,
.agent-content h2,
.agent-content h3,
.agent-content strong {
  color: #ffd97a !important;
}

/* Links */
.agent-content a {
  color: #a8d5ff !important;
  text-decoration: underline;
  text-decoration-color: rgba(168,213,255,0.6);
}
.agent-content a:hover {
  color: #d5b97f !important;
}

/* Blocks and cards */
.agent-content .card,
.agent-content blockquote,
.agent-content pre,
.agent-content code {
  background: rgba(255,255,255,0.05) !important;
  border: 1px solid rgba(255,255,255,0.1) !important;
  border-radius: 8px !important;
  padding: 0.75em !important;
  color: #fff8e1 !important;
}

/* Layout helpers (so spreads/grids stay visible) */
.agent-content .spread,
.agent-content .grid,
.agent-content .layout {
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) !important;
  gap: 1rem !important;
}

/* === Layout improvements === */

/* Make chat window wider */
#chat {
  width: 90%;
  max-width: 1200px;
  height: 75vh;
  margin: 0 auto;
  padding: 1.5rem;
  border: 1px solid #333;
  border-radius: 12px;
  overflow-y: auto;
  background: rgba(30, 30, 30, 0.85);
}

/* Make message bubbles wrap neatly */
.agent-content {
  overflow-x: auto;
  word-wrap: break-word;
}

/* Tarot card scaling and style */
.agent-content img {
  max-width: 160px;
  height: auto;
  border-radius: 10px;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
  background: #111;
}

/* Slight padding for input and chat alignment */
#inputBox {
  max-width: 1200px;
  margin: 1rem auto;
  display: flex;
  justify-content: center;
  gap: 1rem;
}

  main, .wrapper {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Safety rule for agent-generated layouts */
.agent-content {
  max-width: 100%;
  overflow-x: auto;
}

.agent-content .spread {
  transform-origin: center;
  scale: 0.95; /* gentle downscale if layout is large */
}

.agent-content img {
  max-width: 100%;
  height: auto;
}

</style>
</head>
<body>
  <h1>üîÆ Tarot Chat</h1>
  <button id="newReadingBtn" onclick="newReading()">New Reading</button>
  <div id="chat"></div>
  <div id="inputBox">
    <textarea id="msg" placeholder="Ask your question..." rows="2"></textarea>
    <button onclick="sendMsg()">Send</button>
  </div>

<script>
const chat = document.getElementById("chat");
const msgInput = document.getElementById("msg");
// const streamBase = "https://tarot-chat.onrender.com";
let source;

const serverBase = window.location.origin;

  function connectStream(sessionId) {
  if (source) source.close(); // ‚úÖ close previous connection before opening new
  source = new EventSource(`${serverBase}/events/${sessionId}`); // ‚úÖ no ‚Äúconst‚Äù here

  source.onmessage = (event) => {
    if (!event.data) return;
    const data = JSON.parse(event.data);
    if (data.status === "connected") return;
    if (data.text) {
      const agentBlock = document.createElement("div");
agentBlock.className = "agent-content";
agentBlock.innerHTML = data.text;
chat.appendChild(agentBlock);
chat.scrollTop = chat.scrollHeight;
    }
  };

  source.onerror = (err) => console.error("SSE error", err);
  window.addEventListener("beforeunload", () => source?.close());
}

// create/reuse session + connect ONCE at load
const sessionId = localStorage.getItem("sessionId") || crypto.randomUUID();
localStorage.setItem("sessionId", sessionId);
connectStream(sessionId);

async function sendMsg() {
  const text = msgInput.value.trim();
  if (!text) return;

  chat.innerHTML += `<div class="msg user">${text}</div>`;
  msgInput.value = "";

  await fetch("/webhook/tarot-chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ question: text, sessionId }),
  });
}

// Allow Enter to send, Shift+Enter for newline
msgInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault(); // stop it from making a new line
    sendMsg(); // send the message
  }
});

  
  function newReading() {
  // Clear the chat visually
  chat.innerHTML = "";

  // Generate a new session ID so the new reading starts fresh
  const newSessionId = crypto.randomUUID();
  localStorage.setItem("sessionId", newSessionId);

  // Reconnect the stream for the new session
  connectStream(newSessionId);

  // Optionally, add a system message
  chat.innerHTML += `<div class="msg"><em>‚ú® New reading started. Ask your next question.</em></div>`;
}

</script>

</body>
</html>
